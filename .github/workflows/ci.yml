name: Android CI

on:
    pull_request:
        branches: [ "main", "develop" ]
    push:
        branches: [ "main", "develop" ]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build-test-lint:
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Validate Gradle Wrapper
              uses: gradle/actions/wrapper-validation@v4

            - name: Set up JDK
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "11"

            - name: Setup Gradle
              uses: gradle/actions/setup-gradle@v4
              with:
                  cache-read-only: ${{ github.event_name == 'pull_request' }}

            - name: Grant execute permission for gradlew
              run: chmod +x ./gradlew

            - name: Ktlint (check)
              run: ./gradlew ktlintCheck --no-daemon

            - name: Unit tests
              run: ./gradlew testDebugUnitTest --no-daemon

            - name: Android Lint
              run: ./gradlew lintDebug --no-daemon

            - name: Build (Debug)
              run: ./gradlew assembleDebug --no-daemon

            - name: Upload reports
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: reports
                  path: |
                      **/build/reports/**
                      **/build/test-results/**
                  if-no-files-found: ignore
